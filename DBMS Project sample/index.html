<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibraScan | Modern Library Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Custom Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }

        /* Splash Screen Animation */
        .fade-in {
            animation: fade-in 1.5s forwards;
        }
        @keyframes fade-in {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Custom Scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
        }

        /* Utility for hiding pages */
        .page-hidden {
            display: none !important;
        }

        /* CSS for Collapsed Sidebar State (Desktop) */
        .sidebar-collapsed {
            width: 5rem; /* w-20 in Tailwind */
        }
        .sidebar-expanded {
            width: 16rem; /* w-64 in Tailwind */
        }
        .main-content-shifted {
            margin-left: 5rem; /* Match collapsed width w-20 */
        }
        .main-content-expanded {
            margin-left: 16rem; /* Match expanded width w-64 */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 1. SPLASH SCREEN (Fixed and Centered with library background image) -->
    <div id="splash-screen" 
        class="fixed inset-0 z-[100] flex items-center justify-center fade-in transition-opacity duration-500" 
        style="background-image: url('Gemini_Generated_Image_gzyjepgzyjepgzyj.png'); background-size: cover; background-position: center;">
        
        <!-- Dark Overlay for Contrast -->
        <div class="absolute inset-0 bg-black/60"></div>

        <!-- Content Card (Relative to be on top of the overlay) -->
        <div class="relative flex flex-col items-center justify-center p-8 rounded-xl shadow-2xl bg-white/10 backdrop-blur-sm text-white border border-white/20">
            <img id="logo-img" src="Gemini_Generated_Image_liigqxliigqxliig.png" alt="LibraScan Logo" class="w-60 mb-6 animate-pulse">
            <h1 class="text-3xl font-extrabold text-blue-400 mb-2">LibraScan</h1>
            <p class="text-lg text-gray-200">Initializing the Library System...</p>
        </div>
    </div>

    <!-- 2. MAIN APPLICATION CONTAINER -->
    <div id="app-container" class="flex min-h-screen pt-1 transition-opacity duration-500 opacity-0 page-hidden">
        
        <!-- 2.1 SIDEBAR -->
        <aside id="sidebar" class="fixed h-full bg-gray-900 text-white p-2 shadow-xl transition-all duration-300 sidebar-collapsed md:sidebar-collapsed z-50">
            <div class="flex flex-col h-full overflow-hidden">
                
                <!-- Toggle Button (Always visible on desktop) -->
                <button id="sidebar-toggle-desktop" class="hidden md:block absolute top-4 -right-3 p-1 rounded-full bg-gray-800 text-white shadow-lg z-50 transition-transform duration-300">
                    <i id="toggle-icon" data-lucide="chevron-right" class="w-5 h-5 transition-transform duration-300"></i>
                </button>

                <!-- Logo/Title -->
                <div class="mb-4 mt-2 px-3 border-b border-gray-700 pb-3 flex items-center justify-center">
                    <div id="logo-expanded" class="hidden flex-col items-start w-full">
                        <h2 class="text-2xl font-bold text-blue-400">LibraScan</h2>
                        <p class="text-sm text-gray-400">Management Suite</p>
                    </div>
                    <i id="logo-collapsed" data-lucide="book-open-check" class="w-8 h-8 text-blue-400"></i>
                </div>

                <!-- Navigation -->
                <nav class="space-y-2 flex-grow px-1">
                    <button onclick="navigateTo('dashboard')" id="nav-dashboard"
                        class="nav-item w-full flex items-center p-3 rounded-lg text-gray-200 hover:bg-gray-700 transition-colors bg-gray-700 justify-center md:justify-start group">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 mr-0 md:mr-3"></i> 
                        <span class="hidden md:inline-block expanded-text whitespace-nowrap">Dashboard</span>
                    </button>
                    <!-- Add Book and Search Book removed as requested -->
                </nav>

                <!-- Utility Menu (Report Download) -->
                <div class="mt-auto pt-4 border-t border-gray-700 px-1">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase mb-3 px-2 hidden expanded-text">Utility</h3>
                    <button onclick="downloadReport()"
                        class="nav-item w-full flex items-center justify-center py-3 px-1 md:py-2 md:px-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md group">
                        <i data-lucide="download" class="w-5 h-5 mr-0 md:mr-2"></i> 
                        <span class="hidden md:inline-block expanded-text whitespace-nowrap">Download Records</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Sidebar Toggle for Mobile (Standard behavior remains) -->
        <button id="sidebar-toggle-mobile" class="fixed top-4 left-4 p-2 bg-gray-800 text-white rounded-md md:hidden z-50 shadow-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>

        <!-- 2.2 MAIN CONTENT AREA -->
        <main id="main-content" class="flex-grow p-6 transition-all duration-300 main-content-shifted">
            
            <!-- Dynamic Header/Back Button Area -->
            <div class="flex items-center mb-6 border-b pb-4">
                <!-- Back Button (Initially hidden) -->
                <button id="back-button" onclick="goBackToDashboard()" 
                    class="hidden items-center text-gray-600 hover:text-blue-600 transition-colors mr-4 focus:outline-none">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h1 id="page-title" class="text-4xl font-extrabold text-gray-800">Welcome Back to LibraScan!</h1>
            </div>

            <!-- DYNAMIC PAGE CONTENT -->
            <div id="page-content" class="space-y-8">
                <!-- 2.2.1 DASHBOARD VIEW -->
                <div id="dashboard-view" class="page-view">
                    
                    <!-- Quick Actions - Updated to use navigation -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 border-l-4 border-blue-500 cursor-pointer" 
                             onclick="navigateTo('add_book')">
                            <h2 class="text-2xl font-bold text-gray-700 mb-2 flex items-center"><i data-lucide="book-plus" class="w-6 h-6 mr-3 text-blue-500"></i> Add New Book</h2>
                            <p class="text-gray-500">Upload book images (cover and ISBN page) for automated record creation.</p>
                        </div>
                        <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 border-l-4 border-green-500 cursor-pointer"
                             onclick="navigateTo('search_book')">
                            <h2 class="text-2xl font-bold text-gray-700 mb-2 flex items-center"><i data-lucide="search" class="w-6 h-6 mr-3 text-green-500"></i> Search Library</h2>
                            <p class="text-gray-500">Quickly find records by title, author, ISBN, or publisher.</p>
                        </div>
                    </div>

                    <!-- System Overview -->
                    <div class="mt-8">
                        <h2 class="text-3xl font-bold text-gray-700 mb-4">System Overview</h2>
                        
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-md border-b-4 border-yellow-500">
                                <p class="text-sm text-gray-500">Total Books</p>
                                <p id="total-books" class="text-4xl font-extrabold text-gray-900 mt-1">4,208</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md border-b-4 border-red-500">
                                <p class="text-sm text-gray-500">Records Added Today</p>
                                <p id="today-records" class="text-4xl font-extrabold text-gray-900 mt-1">17</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2.2.2 ADD BOOK VIEW -->
                <div id="add_book-view" class="page-view page-hidden">
                    <p class="text-gray-500 mb-8">Upload images for automated data extraction.</p>

                    <div class="bg-white p-8 rounded-xl shadow-lg space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- File Uploader 1 -->
                            <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 transition-colors">
                                <label class="block text-lg font-medium text-gray-700 mb-2">Image 1: Book Cover</label>
                                <input type="file" id="image-1-upload" accept="image/*" class="w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>
                            <!-- File Uploader 2 -->
                            <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                                <label class="block text-lg font-medium text-gray-700 mb-2">Image 2: Title/ISBN Page</label>
                                <input type="file" id="image-2-upload" accept="image/*" class="w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                            </div>
                        </div>

                        <button onclick="processUpload()" id="process-btn"
                            class="w-full py-3 px-6 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition-transform duration-200 transform hover:scale-[1.01] shadow-lg">
                            <i data-lucide="zap" class="w-5 h-5 inline mr-2"></i> Process Images and Save Record
                        </button>
                        
                        <div id="upload-status" class="text-center p-3 rounded-lg text-sm text-gray-600 hidden"></div>
                    </div>
                </div>

                <!-- 2.2.3 SEARCH BOOK VIEW -->
                <div id="search_book-view" class="page-view page-hidden">
                    <p class="text-gray-500 mb-8">Find books quickly by matching keywords.</p>
                    
                    <div class="bg-white p-8 rounded-xl shadow-lg space-y-6">
                        <div class="flex space-x-3">
                            <input type="text" id="search-input" placeholder="Search using Title, Author, Publisher, or ISBN..."
                                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors shadow-sm">
                            <button onclick="performSearch()"
                                class="py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                <i data-lucide="search" class="w-5 h-5 inline"></i>
                            </button>
                        </div>

                        <div id="search-results-area" class="mt-6">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Results:</h3>
                            <div id="results-table" class="space-y-3">
                                <p class="text-gray-500 italic">Enter a query to see results...</p>
                                <!-- Mock results will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
   

    <!-- JavaScript for Navigation and Interaction -->
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentPage = 'dashboard';
        let sidebarExpanded = false;
        const pageTitles = {
            'dashboard': 'Welcome Back to LibraScan!',
            'add_book': 'Add New Book Record',
            'search_book': 'Search Book Records'
        };

        // Helper function to initialize Lucide icons
        const initIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                setTimeout(initIcons, 100); 
            }
        };
        
        // --- 1. Sidebar Collapse/Expand Logic ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const toggleIcon = document.getElementById('toggle-icon');
            const expandedTexts = document.querySelectorAll('.expanded-text');

            sidebarExpanded = !sidebarExpanded;

            if (sidebarExpanded) {
                // Expand
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                mainContent.classList.remove('main-content-shifted');
                mainContent.classList.add('main-content-expanded');
                toggleIcon.style.transform = 'rotate(180deg)';
                document.getElementById('logo-collapsed').classList.add('hidden');
                document.getElementById('logo-expanded').classList.remove('hidden');
                expandedTexts.forEach(el => el.classList.remove('hidden'));

            } else {
                // Collapse
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
                mainContent.classList.remove('main-content-expanded');
                mainContent.classList.add('main-content-shifted');
                toggleIcon.style.transform = 'rotate(0deg)';
                document.getElementById('logo-expanded').classList.add('hidden');
                document.getElementById('logo-collapsed').classList.remove('hidden');
                expandedTexts.forEach(el => el.classList.add('hidden'));
            }
            // Re-center dashboard button icon when collapsed/expanded
            const navDashboard = document.getElementById('nav-dashboard');
            if (sidebarExpanded) {
                 navDashboard.classList.remove('justify-center');
                 navDashboard.classList.add('justify-start');
            } else {
                 navDashboard.classList.add('justify-center');
                 navDashboard.classList.remove('justify-start');
            }
        }

        // --- 2. Navigation Logic ---
        function navigateTo(pageId) {
    currentPage = pageId;
    const views = document.querySelectorAll('.page-view');
    const navItems = document.querySelectorAll('.nav-item');
    const backButton = document.getElementById('back-button');
    const pageTitleEl = document.getElementById('page-title');

    views.forEach(view => {
        view.classList.add('page-hidden');
    });
    
    navItems.forEach(item => {
        item.classList.remove('bg-gray-700');
    });

    // Update page content
    document.getElementById(`${pageId}-view`).classList.remove('page-hidden');
    pageTitleEl.textContent = pageTitles[pageId] || '';

    // Refresh stats when navigating to dashboard
    if (pageId === 'dashboard') {
        document.getElementById(`nav-${pageId}`).classList.add('bg-gray-700');
        backButton.classList.add('hidden');
        backButton.classList.remove('flex');
        updateDashboardStats(); // ← ADD THIS LINE
    } else {
        backButton.classList.remove('hidden');
        backButton.classList.add('flex');
    }
    
    // Close sidebar on mobile
    if (window.innerWidth < 768) {
        document.getElementById('sidebar').classList.add('-translate-x-full');
    }
    
    initIcons();
}
        
        // --- 3. Back to Dashboard Logic ---
        function goBackToDashboard() {
            navigateTo('dashboard');
        }
        
        // --- 4. Splash Screen Logic ---
        function hideSplashScreen() {
            const splash = document.getElementById('splash-screen');
            const app = document.getElementById('app-container');

            splash.style.opacity = '0';
            setTimeout(() => {
                splash.classList.add('page-hidden');
                app.classList.remove('page-hidden');
                app.style.opacity = '1';
                // Initialize icons for the main content
                initIcons();
            }, 500);
        }

        // --- 5. Sidebar Mobile Toggle (original for small screens) ---
        document.getElementById('sidebar-toggle-mobile').addEventListener('click', () => {
             // On mobile, the sidebar is always fully expanded when open
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
            
            // For mobile, ensure it looks expanded when open
            if (!sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                document.getElementById('logo-collapsed').classList.add('hidden');
                document.getElementById('logo-expanded').classList.remove('hidden');
                document.querySelectorAll('.expanded-text').forEach(el => el.classList.remove('hidden'));
                 document.getElementById('nav-dashboard').classList.remove('justify-center');
                 document.getElementById('nav-dashboard').classList.add('justify-start');
            } else {
                 // Reset classes on close (not strictly necessary for functionality but good practice)
                 sidebar.classList.add('sidebar-collapsed');
                 sidebar.classList.remove('sidebar-expanded');
            }
        });

        // --- 6. Mock Data and Interaction Functions ---

        function downloadReport() {
            alertMessage('info', 'Preparing Excel Report...');
            setTimeout(() => {
                alertMessage('success', 'Report generation complete! (A download would start in a real application)');
            }, 1500);
        }
        
        async function processUpload() {
    const file1 = document.getElementById('image-1-upload').files[0];
    const file2 = document.getElementById('image-2-upload').files[0];

    if (!file1 || !file2) {
        alertMessage('error', 'Please upload both the Book Cover and the Title/ISBN Page images.');
        return;
    }

    // Disable button during processing
    const processBtn = document.getElementById('process-btn');
    processBtn.disabled = true;
    processBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 inline mr-2 animate-spin"></i> Processing...';

    const formData = new FormData();
    formData.append('image1', file1);
    formData.append('image2', file2);

    try {
        const response = await fetch(`${API_BASE}/process-book`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alertMessage('success', result.message);
            // Clear form
            document.getElementById('image-1-upload').value = null;
            document.getElementById('image-2-upload').value = null;
            
            // Refresh dashboard stats and search results
            await refreshAfterUpload(); // ← ADD THIS LINE
        } else {
            alertMessage('error', result.message);
        }
    } catch (error) {
        alertMessage('error', `Network error: ${error.message}`);
    } finally {
        // Re-enable button
        processBtn.disabled = false;
        processBtn.innerHTML = '<i data-lucide="zap" class="w-5 h-5 inline mr-2"></i> Process Images and Save Record';
        initIcons();
    }
}

        async function performSearch() {
    const query = document.getElementById('search-input').value.trim();
    const resultsArea = document.getElementById('results-table');
    
    try {
        alertMessage('info', `Searching for: "${query}"...`);
        
        const response = await fetch(`${API_BASE}/search-books?q=${encodeURIComponent(query)}`);
        const result = await response.json();
        
        if (result.success) {
            if (result.books && result.books.length > 0) {
                resultsArea.innerHTML = result.books.map(book => `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                        <p class="font-bold text-lg text-blue-600">${book.title}</p>
                        <p class="text-sm text-gray-700">Author: ${book.authors} | Publisher: ${book.publisher}</p>
                        <p class="text-xs text-gray-500">Subjects: ${book.subjects} | ID: ${book.control_no}</p>
                    </div>
                `).join('');
            } else {
                resultsArea.innerHTML = `<p class="text-red-500 font-semibold">No results found for "${query}".</p>`;
            }
        } else {
            resultsArea.innerHTML = `<p class="text-red-500 font-semibold">Search error: ${result.message}</p>`;
        }
        
        document.getElementById('upload-status').classList.add('hidden');
    } catch (error) {
        alertMessage('error', `Search failed: ${error.message}`);
    }
}

        function alertMessage(type, message) {
            const statusDiv = document.getElementById('upload-status');
            statusDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            
            let className = '';
            
            switch(type) {
                case 'error':
                    className = 'bg-red-100 text-red-700 border-l-4 border-red-500';
                    break;
                case 'success':
                    className = 'bg-green-100 text-green-700 border-l-4 border-green-500';
                    break;
                case 'info':
                default:
                    className = 'bg-blue-100 text-blue-700 border-l-4 border-blue-500';
                    break;
            }
            
            statusDiv.className = `text-center p-3 rounded-lg text-sm transition-opacity duration-300 ${className}`;
            statusDiv.innerHTML = `<i data-lucide="${type === 'error' ? 'alert-triangle' : type === 'success' ? 'check-circle' : 'info'}" class="w-4 h-4 inline mr-2 align-text-bottom"></i> ${message}`;
            initIcons(); 
        }
       // Function to fetch and update dashboard stats
async function updateDashboardStats() {
    try {
        console.log('Fetching dashboard stats...');
        const response = await fetch(`${API_BASE}/dashboard-stats`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Dashboard stats result:', result);
        
        if (result.success) {
            const stats = result.stats;
            
            // Update total books
            const totalBooksEl = document.getElementById('total-books');
            if (totalBooksEl) {
                totalBooksEl.textContent = stats.total_books.toLocaleString();
            }
            
            // Update today's records
            const todayRecordsEl = document.getElementById('today-records');
            if (todayRecordsEl) {
                todayRecordsEl.textContent = stats.today_records.toLocaleString();
            }
        } else {
            console.error('Failed to fetch stats:', result.message);
            // Keep the default static values if API fails
        }
    } catch (error) {
        console.error('Error fetching dashboard stats:', error);
        // Keep the default static values if there's an error
    }
}

// Function to refresh stats after book upload
async function refreshAfterUpload() {
    await updateDashboardStats();
    // Also refresh search results if we're on search page
    if (currentPage === 'search_book') {
        await performSearch();
    }
}


        // --- 7. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Attach toggle function to the new desktop toggle button
            document.getElementById('sidebar-toggle-desktop').addEventListener('click', toggleSidebar);
            
            // Start the splash timer
            setTimeout(hideSplashScreen, 3000);
            
            // Set initial state (sidebar collapsed by default on desktop)
            // Call once to set initial collapsed state for all elements
            sidebarExpanded = true; // Set to true so the first call to toggle collapses it
            toggleSidebar(); // Collapse the sidebar on load

            // Set initial navigation state once the app is visible
            navigateTo('dashboard');
            
            document.getElementById('logo-img').onerror = function() {
                this.src = 'https://placehold.co/300x100/4F8BF9/ffffff?text=LibraScan';
                this.onerror = null; 
            };
        });
    </script>
</body>
</html>